From https://github.com/hugohrban/matrix_library - refactor and tidy up.